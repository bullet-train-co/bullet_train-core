# Installing Bullet-Train Themes on Other Rails Projects

Bullet Train themes can be installed on Vanilla Rails projects.

Our main theme, called `Light`, uses `erb` partials to give you native Rails views with Hotwire-powered components. It's built on `tailwindcss`, uses `postcss` to allow for local CSS overrides and uses `esbuild` for fast javascript compilation and to support javascript-side CSS imports.

Note: we have [special instructions for installing themes on Jumpstart PRO projects](on-jumpstart-pro-projects.md).

## Installation Instructions

### Ensure your Rails Project uses `esbuild` and `tailwindcss` with `postcss`

You'll need to make sure your Rails project is set up to use `esbuild`, `tailwindcss` and `postcss`.

The easiest way to see what your project should include is to create a separate project, for reference, generated via this command:

```
$ rails new rails-new-esbuild-tailwind-postcss --css tailwind --javascript esbuild
```

### Add the theme gem

These instructions assume you're installing the `Light` theme bundled with Bullet Train.

```
$ bundle add bullet_train-themes-light
```

Or add the following to your `Gemfile`:

```
gem "bullet_train-themes-light"
```

And then run:

```
$ bundle install
```

### Add `npm` packages

The `Light` theme requires the following npm packages to be installed

```
$ yarn add @bullet-train/bullet-train @bullet-train/fields autoprefixer @rails/actiontext
```

Update your `app/javascript/controllers/index.js` with the following lines:

```js
import { controllerDefinitions as bulletTrainControllers } from "@bullet-train/bullet-train"
import { controllerDefinitions as bulletTrainFieldControllers } from "@bullet-train/fields"

application.load(bulletTrainControllers)
application.load(bulletTrainFieldControllers)
```

**(This should be automated by a rake task)**

### Add `bin/theme` and `bin/link` bin stubs

**(This should be automated by a rake task)**

### Update `tailwind.config.js`

Replace with these contents:

**(This should be automated via a rake task, merged with AI if there's an existing esbuild file)**

```js
const path = require('path');
const { execSync } = require("child_process");
const glob  = require('glob').sync

if (!process.env.THEME) {
  throw "tailwind.config.js: missing process.env.THEME"
  process.exit(1)
}
  
const themeConfigFile = execSync(`bundle exec bin/theme tailwind-config ${process.env.THEME}`).toString().trim()
let themeConfig = require(themeConfigFile)

// *** Uncomment these if required for your overrides ***

// const defaultTheme = require('tailwindcss/defaultTheme')
// const colors = require('tailwindcss/colors')

// *** Add your own overrides here ***

// themeConfig.theme.extend.fontFamily.sans = ['Custom Font Name', ...themeConfig.theme.extend.fontFamily.sans]
// themeConfig.theme.extend.fontSize['2xs'] = '.75rem'
// themeConfig.content.push('./app/additional/path')
// themeConfig.plugins.push(require('additional-tailwind-plugin'))

module.exports = themeConfig
```

### Update `postcss.config.js`

Replace with these contents:

**(This should be automated via a rake task, merged with AI if there's an existing esbuild file)**

```js
const { execSync } = require("child_process");

const postcssImportConfigFile = execSync(`bundle exec bin/theme postcss-import-config ${process.env.THEME}`).toString().trim()
const postcssImportConfig = require(postcssImportConfigFile)

module.exports = {
  plugins: [
    require('postcss-import')(postcssImportConfig),
    require('postcss-extend-rule'),
    require('tailwindcss/nesting'),
    require('tailwindcss'),
    require('autoprefixer')
  ]
}
```

### Update `build:css` in `package.json`

In `package.json`, add or replace the `build:css` entry under `scripts` with:

**(This should be automated via a rake task)**

```json
"build:css": "bin/link; THEME=\"light\" tailwindcss --postcss --minify -c ./tailwind.config.js -i ./app/assets/stylesheets/application.tailwind.css -o ./app/assets/builds/application.light.css"
```

### Update Style Sheets

(application.tailwind.css should be the default)  
(application.css is auto-generated by esbuild)

### Import the Theme Style Sheet

**(This should be automated by a rake task)**

To your application.tailwind.css file, add the following line:

```css
@import "$ThemeStylesheetsDir/light/application.css";
```

### Add Themify Icons

(This should be imported via the npm package automatically)

### Update `esbuild.config.js`

Replace it with these contents.

**(This should be automated via a rake task, merged with AI if there's an existing esbuild file)**

```js
const path = require('path');
const { execSync } = require("child_process");
const glob = require('glob').sync

// Glob plugin derived from:
// https://github.com/thomaschaaf/esbuild-plugin-import-glob
// https://github.com/xiaohui-zhangxh/jsbundling-rails/commit/b15025dcc20f664b2b0eb238915991afdbc7cb58
const ImportGlobPlugin = () => ({
  name: 'require-context',
  setup: (build) => {
    build.onResolve({ filter: /\*/ }, async (args) => {
      console.log('resolveDir', args.resolveDir)
      if (args.resolveDir === '') {
        return; // Ignore unresolvable paths
      }
      console.log('path', args.path)
      return {
        path: args.path,
        namespace: 'import-glob',
        pluginData: {
          resolveDir: args.resolveDir,
        },
      };
    });

    build.onLoad({ filter: /.*/, namespace: 'import-glob' }, async (args) => {
      const files = (
        glob(args.path, {
          cwd: args.pluginData.resolveDir,
        })
      ).sort();

      let importerCode = `
        ${files
          .map((module, index) => `import * as module${index} from './${module}'`)
          .join(';')}
        export default [${files
          .map((module, index) => `module${index}.default`)
          .join(',')}];
        export const context = {
          ${files.map((module, index) => `'${module}': module${index}.default`).join(',')}
        }
      `;

      return { contents: importerCode, resolveDir: args.pluginData.resolveDir };
    });
  },
});

let themeFile = ""
if (process.env.THEME) {
  themeFile = execSync(`bundle exec bin/theme javascript ${process.env.THEME}`).toString().trim()
}

// Could also swap to packs?
const otherEntrypoints = {}
glob("app/javascript/entrypoints/**/*.*")
  .forEach((file) => {
    // strips app/javascript/entrypoints from the key.
    const key = path.join(path.dirname(file), path.parse(file).name).split(path.sep + "entrypoints" + path.sep)[1]
    const value = "." + path.sep + path.join(path.dirname(file), path.basename(file))
    otherEntrypoints[key] = value
  });

const themeEntrypoints = {}
if (process.env.THEME) {
  themeEntrypoints[`application.${process.env.THEME}`] = themeFile
}

let build_details = {
  entryPoints: {
    ...otherEntrypoints,
    "application": path.join(process.cwd(), "app/javascript/application.js"),
    ...themeEntrypoints,
  },
  define: {
    global: "window"
  },
  bundle: true,
  // ESM + Splitting will only work if the script is type="module"
  // splitting: true,
  // format: "esm",
  format: "iife",
  sourcemap: true,
  outdir: path.join(process.cwd(), "app/assets/builds"),
  loader: {
    ".png": "file",
    ".jpg": "file",
    ".svg": "file",
    ".woff": "file",
    ".woff2": "file",
    ".ttf": "file",
    ".eot": "file",
  },
  plugins: [
    ImportGlobPlugin()
  ],
  // TODO: Silencing warnings until the charset warning is fixed.
  logLevel: 'error'
}

async function serve_with_esbuild() {
  let ctx = await require("esbuild").context(build_details)

  await ctx.watch()

  let { host, port } = await ctx.serve({
    servedir: path.join(process.cwd(), "app/assets/builds")
  })
}

if(process.argv.includes("--watch")) {
  serve_with_esbuild()
} else {
  require("esbuild").build(build_details)
}

```

### Add Locale Strings

Add these to your `config/locales/en.yml` under `en:`

```yml
  date:
    formats:
      date_field: "%m/%d/%Y"
      date_and_time_field: "%m/%d/%Y %l:%M %p"
      date_controller: "MM/DD/YYYY"
  time:
    am: AM
    pm: PM
    formats:
      date_field: "%m/%d/%Y"
      date_and_time_field: "%m/%d/%Y %l:%M %p"
      date_controller: "MM/DD/YYYY h:mm A"
  daterangepicker:
    firstDay: 1
    separator: " - "
    applyLabel: "Apply"
    cancelLabel: "Cancel"
    fromLabel: "From"
    toLabel: "To"
    customRangeLabel: "Custom"
    weekLabel: "W"
    daysOfWeek:
    - "Su"
    - "Mo"
    - "Tu"
    - "We"
    - "Th"
    - "Fr"
    - "Sa"
    monthNames:
    - "January"
    - "February"
    - "March"
    - "April"
    - "May"
    - "June"
    - "July"
    - "August"
    - "September"
    - "October"
    - "November"
    - "December"
  date_range_controller:
    today: Today
    yesterday: yesterday
    last7Days: Last 7 Days
    last30Days: Last 30 Days
    thisMonth: This Month
    lastMonth: Last Month
  global:
    buttons:
      other: Other
      cancel: Cancel
    bulk_select:
      all: All
```