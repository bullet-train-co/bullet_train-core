<script>
  class ColorSchemeSelector {
    constructor() {
      this.validSchemes = ['dark', 'light', 'system'];
      this.storageKey = 'color_scheme_preference';
      this.eventName = 'color-scheme:changed'; // custom event dispatched on change
      this.el = document.documentElement;
      this.mq = window.matchMedia('(prefers-color-scheme: dark)');
      
      this.mq.addEventListener('change', e => this.preference === 'system' && (this.#shown = e.matches ? 'dark' : 'light'));
      if (!this.el.className.match(/\b(light|dark)\b/)) this.#shown = this.preference !== 'system' ?? this.#auto();
    }

    get preference() { return localStorage.getItem(this.storageKey) || 'system'; }
    set preference(scheme) {
      if (!this.validSchemes.includes(scheme)) throw new Error('Invalid color scheme');
      const stored = scheme === 'system' ? null : scheme;
      this.#shown = stored ?? this.#auto();
      stored === null ? localStorage.removeItem(this.storageKey) : localStorage.setItem(this.storageKey, scheme);
      document.dispatchEvent(new CustomEvent(this.eventName, { detail: { colorScheme: scheme } }));
    }

    get #shown() { return this.el.classList.contains('dark') ? 'dark' : 'light'; }
    set #shown(scheme) { this.el.classList.remove('dark', 'light'); this.el.classList.add(scheme); }
    #auto() { return this.mq.matches ? 'dark' : 'light'; }
  }

  window.colorScheme = new ColorSchemeSelector();
</script>