name: "ðŸš…  CI"

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ "main" ]

jobs:
  calculate_matrix:
    name: ðŸ§® Calculate Dynamic Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.dynamic-matrix.outputs.matrix }}
      totalRunners: ${{ steps.dynamic-matrix.outputs.totalRunners }}
      testRunnersPerNode: ${{ steps.dynamic-matrix.outputs.testRunnersPerNode }}
    steps:
      - name: Dynamic Matrix
        id: dynamic-matrix
        uses: bullet-train-co/parallel-test-dynamic-matrix@v1
        with:
          # You can explicitly set the number of test nodes, or it will default to 4
          numberOfTestNodes: 4
          # You can explicitly set the number of runners per node, or it will default to 4 for public repos and 2 for private
          # testRunnersPerNode: 2
  show_matrix:
    name: Debug Matrix Calculations
    runs-on: ubuntu-latest
    needs: calculate_matrix
    steps:
      - run: echo "${{ needs.calculate_matrix.outputs.matrix }}"
        shell: bash
      - run: echo "${{ needs.calculate_matrix.outputs.totalRunners }}"
        shell: bash
      - run: echo "${{ needs.calculate_matrix.outputs.testRunnersPerNode }}"
        shell: bash
  minitest:
    name: ðŸ§ª Starter Repo Minitest
    uses: ./.github/workflows/_starter_repo_tests.yml
    secrets: inherit
    needs: calculate_matrix
    with:
      matrix: ${{ needs.calculate_matrix.outputs.matrix }}
      testRunnersPerNode: ${{ needs.calculate_matrix.outputs.testRunnersPerNode }}
      totalRunners: ${{ needs.calculate_matrix.outputs.totalRunners }}
  super_scaffolding:
    name: ðŸ§ª Starter Repo Super Scaffolding Tests
    uses: ./.github/workflows/_run_super_scaffolding_tests.yml
    secrets: inherit
    needs: calculate_matrix
  gem_tests:
    name: ðŸ§ª Gem Tests
    uses: ./.github/workflows/_run_tests.yml
    secrets: inherit
    needs: calculate_matrix
  standardrb:
    name: ðŸ”¬ Standardrb
    uses: ./.github/workflows/_standardrb.yml
    secrets: inherit
  combine_runtime_logs:
    name: ðŸªµ Combine Runtime Logs
    uses: ./.github/workflows/_combine_runtime_logs.yml
    secrets: inherit
    needs: [minitest]
  combine_coverage_data:
    name: ðŸ«£ SimpleCov
    uses: ./.github/workflows/_combine_coverage_data.yml
    secrets: inherit
    needs: [minitest,super_scaffolding,gem_tests]
  combine_summary_logs:
    name: ðŸ“Š Test Results
    uses: ./.github/workflows/_combine_summary_logs.yml
    secrets: inherit
    needs: [minitest,super_scaffolding,gem_tests]
    if: ${{ always() }}
